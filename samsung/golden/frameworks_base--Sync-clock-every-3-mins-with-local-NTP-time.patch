From 7d650837d7696ca306a6b66b7a5633d13efde71d Mon Sep 17 00:00:00 2001
From: Stefan Berger <s.berger81@gmail.com>
Date: Fri, 3 Oct 2014 00:19:42 +0200
Subject: [PATCH] Sync clock every 3 mins with local NTP time

Change-Id: I96d8beca074fc9b784c0c865f548940b400f99b2
---
 .../android/server/NetworkTimeUpdateService.java   |   22 ++++++++++++++------
 1 file changed, 16 insertions(+), 6 deletions(-)

diff --git a/services/java/com/android/server/NetworkTimeUpdateService.java b/services/java/com/android/server/NetworkTimeUpdateService.java
index fddb54e..10fc2f7 100644
--- a/services/java/com/android/server/NetworkTimeUpdateService.java
+++ b/services/java/com/android/server/NetworkTimeUpdateService.java
@@ -151,12 +151,16 @@ public class NetworkTimeUpdateService {
         if (!isAutomaticTimeRequested()) return;
 
         final long refTime = SystemClock.elapsedRealtime();
-        // If NITZ time was received less than mPollingIntervalMs time ago,
-        // no need to sync to NTP.
-        if (mNitzTimeSetTime != NOT_SET && refTime - mNitzTimeSetTime < mPollingIntervalMs) {
-            resetAlarm(mPollingIntervalMs);
-            return;
-        }
+
+	// Only consider NITZ time if mTryAgainTimesMax has a non-negative value
+	if (mTryAgainTimesMax > 0) {
+            // If NITZ time was received less than mPollingIntervalMs time ago,
+            // no need to sync to NTP. 
+            if (mNitzTimeSetTime != NOT_SET && refTime - mNitzTimeSetTime < mPollingIntervalMs) {
+                resetAlarm(mPollingIntervalMs);
+                return;
+            }
+	}
         final long currentTime = System.currentTimeMillis();
         if (DBG) Log.d(TAG, "System time = " + currentTime);
         // Get the NTP time
@@ -204,6 +208,12 @@ public class NetworkTimeUpdateService {
                 return;
             }
         }
+	// Always poll sooner if mTryAgainTimesMax has a negative value
+	if (mTryAgainTimesMax < 0) {
+	    mLastNtpFetchTime = NOT_SET;
+	    resetAlarm(mPollingIntervalShorterMs);
+	    return;
+	}
         resetAlarm(mPollingIntervalMs);
     }
 
-- 
1.7.9.5


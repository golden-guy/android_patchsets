From 35f3a12b4ed76d941dc376a0259dc15c6233b41b Mon Sep 17 00:00:00 2001
From: Stefan Berger <s.berger81@gmail.com>
Date: Wed, 24 Feb 2016 21:35:54 +0100
Subject: [PATCH] base: Prevent device from locking screen while in a phone
 call

For some reason the device locks the screen if the screen timeout has been
exceeded while in a call, despite of the proximity sensor holding a wake lock.
For now, add another check for isOffhook() to keep the phone awake during a call.

Change-Id: I4a9ab4e9838714d94ac596e5223e1b0ee49a19c9
---
 .../android/server/power/PowerManagerService.java  |    5 +++++
 1 file changed, 5 insertions(+)

diff --git a/services/core/java/com/android/server/power/PowerManagerService.java b/services/core/java/com/android/server/power/PowerManagerService.java
index d2a0c7f..c20780d 100644
--- a/services/core/java/com/android/server/power/PowerManagerService.java
+++ b/services/core/java/com/android/server/power/PowerManagerService.java
@@ -60,6 +60,7 @@ import android.os.UserHandle;
 import android.os.WorkSource;
 import android.provider.Settings;
 import android.service.dreams.DreamManagerInternal;
+import android.telephony.TelephonyManager;
 import android.util.EventLog;
 import android.util.Slog;
 import android.util.TimeUtils;
@@ -429,6 +430,8 @@ public final class PowerManagerService extends SystemService
     private final ArrayList<PowerManagerInternal.LowPowerModeListener> mLowPowerModeListeners
             = new ArrayList<PowerManagerInternal.LowPowerModeListener>();
 
+    private TelephonyManager telephonyManager;
+
     // power profile support
     private PowerProfileManager mProfileManager;
     private boolean mProfilesSupported;
@@ -470,6 +473,7 @@ public final class PowerManagerService extends SystemService
     public PowerManagerService(Context context) {
         super(context);
         mContext = context;
+        telephonyManager = (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);
         mHandlerThread = new ServiceThread(TAG,
                 Process.THREAD_PRIORITY_DISPLAY, false /*allowIo*/);
         mHandlerThread.start();
@@ -1699,6 +1703,7 @@ public final class PowerManagerService extends SystemService
     private boolean isBeingKeptAwakeLocked() {
         return mStayOn
                 || mProximityPositive
+                || telephonyManager.isOffhook()
                 || (mWakeLockSummary & WAKE_LOCK_STAY_AWAKE) != 0
                 || (mUserActivitySummary & (USER_ACTIVITY_SCREEN_BRIGHT
                         | USER_ACTIVITY_SCREEN_DIM)) != 0
-- 
1.7.9.5

